<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rollplaying: d6 Dice Pool Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #f97316; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: system-ui, sans-serif; margin: 0; padding: 15px; background: var(--bg); color: #1e293b; }
        .app-container { background: var(--card); width: 100%; max-width: 420px; padding: 20px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin: auto; }
        
        .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.85rem; background: transparent; color: #64748b; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .mode-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; background: white; font-size: 0.75rem; font-weight: bold; color: #64748b; transition: all 0.2s; }
        .toggle-btn.active { border-color: var(--primary); color: var(--primary); background: #eef2ff; }

        .controls { display: grid; gap: 15px; margin-bottom: 20px; }
        label { font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; display: block; }
        
        .stepper { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 4px; }
        .step-btn { width: 42px; height: 42px; border-radius: 8px; border: none; background: white; color: var(--primary); font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .step-value { font-size: 1.1rem; font-weight: 700; width: 60px; text-align: center; }

        .chart-wrapper { height: 200px; margin-bottom: 15px; }
        .table-container { max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f8fafc; padding: 10px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .high { color: #16a34a; font-weight: 700; }
        .low { color: #dc2626; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs">
        <button class="tab active" onclick="setTab('single')">Single Pool</button>
        <button class="tab" onclick="setTab('range')">Pool Range</button>
    </div>

    <label style="text-align:center; margin-bottom:8px">Dice Success Rule</label>
    <div class="mode-toggle">
        <button id="modeOver" class="toggle-btn active" onclick="setMode('over')">Roll Over (X+)</button>
        <button id="modeUnder" class="toggle-btn" onclick="setMode('under')">Roll Under (X-)</button>
    </div>

    <div class="controls">
        <div>
            <label>Success on Die</label>
            <div class="stepper">
                <button class="step-btn" onclick="updateVal('dieTarget', -1)">−</button>
                <div class="step-value" id="dieTargetVal">5+</div>
                <button class="step-btn" onclick="updateVal('dieTarget', 1)">+</button>
            </div>
        </div>

        <div id="secondaryInputContainer">
            <label id="secondaryLabel">Dice in Pool</label>
            <div class="stepper">
                <button class="step-btn" onclick="updateVal('secondary', -1)">−</button>
                <div class="step-value" id="secondaryVal">5</div>
                <button class="step-btn" onclick="updateVal('secondary', 1)">+</button>
            </div>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="table-container">
        <table>
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let currentTab = 'single';
    let currentMode = 'over';
    let dieTarget = 5; 
    let secondaryVal = 5; 
    let myChart;

    function combinations(n, k) {
        if (k < 0 || k > n) return 0;
        let res = 1;
        for (let i = 1; i <= k; i++) res = res * (n - i + 1) / i;
        return res;
    }

    function setTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', (i === 0 && tab === 'single') || (i === 1 && tab === 'range')));
        document.getElementById('secondaryLabel').innerText = tab === 'single' ? 'Dice in Pool' : 'Hits Needed';
        calculate();
    }

    function setMode(mode) {
        currentMode = mode;
        // Adjust dieTarget if it's currently at a limit not supported by the other mode
        if (mode === 'over' && dieTarget < 2) dieTarget = 2;
        document.getElementById('modeOver').classList.toggle('active', mode === 'over');
        document.getElementById('modeUnder').classList.toggle('active', mode === 'under');
        calculate();
    }

    function updateVal(type, change) {
        if (type === 'dieTarget') {
            // Allow 1 if in Under mode, otherwise min is 2
            let minVal = currentMode === 'under' ? 1 : 2;
            dieTarget = Math.min(6, Math.max(minVal, dieTarget + change));
        } else {
            secondaryVal = Math.min(10, Math.max(1, secondaryVal + change));
        }
        calculate();
    }

    function calculate() {
        // Probability p calculation adjusted for 1-6 range
        const p = currentMode === 'over' ? (7 - dieTarget) / 6 : dieTarget / 6;
        const labels = [], exactData = [], cumulativeData = [];
        const tbody = document.getElementById('tableBody');
        const thead = document.getElementById('tableHead');
        tbody.innerHTML = '';
        
        document.getElementById('dieTargetVal').innerText = dieTarget + (currentMode === 'over' ? '+' : '-');
        document.getElementById('secondaryVal').innerText = secondaryVal;

        if (currentTab === 'single') {
            thead.innerHTML = '<tr><th>Hits</th><th>Exactly</th><th>At Least</th></tr>';
            let exactProbs = [];
            for (let k = 0; k <= secondaryVal; k++) {
                const prob = combinations(secondaryVal, k) * Math.pow(p, k) * Math.pow(1 - p, secondaryVal - k);
                exactProbs.push(prob);
            }
            for (let k = 0; k <= secondaryVal; k++) {
                labels.push(k);
                const e = (exactProbs[k] * 100).toFixed(1);
                const c = (exactProbs.slice(k).reduce((a, b) => a + b, 0) * 100).toFixed(1);
                exactData.push(e); cumulativeData.push(c);
                tbody.insertAdjacentHTML('beforeend', `<tr><td>${k}</td><td>${e}%</td><td>${c}%</td></tr>`);
            }
            renderChart(labels, [
                {type:'bar', data:exactData, color:'rgba(99, 102, 241, 0.4)', label: 'Exactly'},
                {type:'line', data:cumulativeData, color:'#f97316', label: 'At Least'}
            ]);
        } else {
            thead.innerHTML = '<tr><th>Dice Pool</th><th>Prob. of Success</th></tr>';
            for (let n = 1; n <= 10; n++) {
                labels.push(n + 'd');
                let probSum = 0;
                for (let k = secondaryVal; k <= n; k++) {
                    probSum += combinations(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
                }
                const pct = (probSum * 100).toFixed(1);
                cumulativeData.push(pct);
                tbody.insertAdjacentHTML('beforeend', `<tr><td>${n} Dice</td><td class="${pct > 70 ? 'high' : pct < 30 ? 'low' : ''}">${pct}%</td></tr>`);
            }
            renderChart(labels, [{type:'line', data:cumulativeData, color:'#6366f1', label: 'Success Chance'}]);
        }
    }

    function renderChart(labels, datasets) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: datasets.map(d => ({
                    type: d.type, label: d.label, data: d.data, borderColor: d.color, backgroundColor: d.color,
                    borderWidth: 3, pointRadius: 4, tension: 0.3, borderRadius: 4
                }))
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, max: 100, ticks: { stepSize: 25, callback: v => v + '%' } }
                },
                plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 10, font: { size: 10 } } } }
            }
        });
    }

    calculate();
</script>
</body>
</html>
