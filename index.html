<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rollplaying: d6 Dice Pool Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #f97316; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: system-ui, sans-serif; margin: 0; padding: 12px; background: var(--bg); color: #1e293b; }
        .app-container { background: var(--card); width: 100%; max-width: 420px; padding: 18px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin: auto; box-sizing: border-box; }
        
        .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.8rem; background: transparent; color: #64748b; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .mode-toggle { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; background: white; font-size: 0.7rem; font-weight: bold; color: #64748b; }
        .toggle-btn.active { border-color: var(--primary); color: var(--primary); background: #eef2ff; }

        .controls-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-group { flex: 1; min-width: 0; }
        
        label { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; display: block; white-space: nowrap; }
        
        .stepper { display: flex; align-items: center; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 2px; }
        .step-btn { width: 34px; height: 34px; border-radius: 6px; border: none; background: white; color: var(--primary); font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .step-value { font-size: 1rem; font-weight: 700; flex: 1; text-align: center; }

        .chart-wrapper { height: 180px; margin-bottom: 15px; }
        .table-container { max-height: 180px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { background: #f8fafc; padding: 8px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; cursor: pointer; user-select: none; }
        tr.selected { background: #eef2ff; }

        .compare-box { background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 12px; padding: 12px; text-align: center; }
        .compare-title { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
        .compare-grid { display: flex; align-items: center; justify-content: space-around; font-weight: 700; font-size: 0.9rem; min-height: 24px; }
        .diff-tag { background: var(--secondary); color: white; padding: 2px 8px; border-radius: 20px; font-size: 0.75rem; }
        .high { color: #16a34a; font-weight: 700; }
        .low { color: #dc2626; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs">
        <button class="tab active" id="tabSingle" onclick="setTab('single')">Single Pool</button>
        <button class="tab" id="tabRange" onclick="setTab('range')">Pool Range</button>
    </div>

    <div class="mode-toggle">
        <button id="modeOver" class="toggle-btn active" onclick="setMode('over')">Roll Over (X+)</button>
        <button id="modeUnder" class="toggle-btn" onclick="setMode('under')">Roll Under (X-)</button>
    </div>

    <div class="controls-row">
        <div class="input-group">
            <label>Success on Die</label>
            <div class="stepper">
                <button class="step-btn" onclick="updateVal('dieTarget', -1)">−</button>
                <div class="step-value" id="dieTargetVal">5+</div>
                <button class="step-btn" onclick="updateVal('dieTarget', 1)">+</button>
            </div>
        </div>

        <div class="input-group">
            <label id="secondaryLabel">Dice in Pool</label>
            <div class="stepper">
                <button class="step-btn" onclick="updateVal('secondary', -1)">−</button>
                <div class="step-value" id="secondaryVal">5</div>
                <button class="step-btn" onclick="updateVal('secondary', 1)">+</button>
            </div>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="table-container">
        <table>
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="compare-box">
        <div class="compare-title">Compare Results (Tap rows)</div>
        <div class="compare-grid" id="compareDisplay">
            <span style="color:#94a3b8; font-weight:normal; font-size:0.75rem">Tap two rows to see the difference</span>
        </div>
    </div>
</div>

<script>
    let currentTab = 'single';
    let currentMode = 'over';
    let dieTarget = 5; 
    let secondaryVal = 5; 
    let myChart;
    let selectedRows = [];

    function combinations(n, k) {
        if (k < 0 || k > n) return 0;
        let res = 1;
        for (let i = 1; i <= k; i++) res = res * (n - i + 1) / i;
        return res;
    }

    function setTab(tab) {
        currentTab = tab;
        selectedRows = [];
        document.querySelectorAll('.tab').forEach((t) => t.classList.toggle('active', t.innerText.toLowerCase().includes(tab)));
        document.getElementById('secondaryLabel').innerText = tab === 'single' ? 'Dice in Pool' : 'Hits Needed';
        calculate();
    }

    function setMode(mode) {
        currentMode = mode;
        selectedRows = [];
        if (mode === 'over') {
            dieTarget = Math.max(2, dieTarget);
        } else {
            dieTarget = Math.min(5, dieTarget);
        }
        document.getElementById('modeOver').classList.toggle('active', mode === 'over');
        document.getElementById('modeUnder').classList.toggle('active', mode === 'under');
        calculate();
    }

    function updateVal(type, change) {
        if (type === 'dieTarget') {
            const min = currentMode === 'under' ? 1 : 2;
            const max = currentMode === 'under' ? 5 : 6;
            dieTarget = Math.min(max, Math.max(min, dieTarget + change));
        } else {
            secondaryVal = Math.min(10, Math.max(1, secondaryVal + change));
        }
        selectedRows = [];
        calculate();
    }

    function toggleRowSelection(id, prob) {
        const index = selectedRows.findIndex(r => r.id === id);
        if (index > -1) {
            selectedRows.splice(index, 1);
        } else {
            if (selectedRows.length >= 2) selectedRows.shift();
            selectedRows.push({id, prob});
        }
        calculate(false);
    }

    function calculate(resetSelections = true) {
        if (resetSelections === true) selectedRows = [];
        
        const p = currentMode === 'over' ? (7 - dieTarget) / 6 : dieTarget / 6;
        const labels = [], exactData = [], cumulativeData = [];
        const tbody = document.getElementById('tableBody');
        const thead = document.getElementById('tableHead');
        tbody.innerHTML = '';
        
        document.getElementById('dieTargetVal').innerText = dieTarget + (currentMode === 'over' ? '+' : '-');
        document.getElementById('secondaryVal').innerText = secondaryVal;

        if (currentTab === 'single') {
            thead.innerHTML = '<tr><th>Hits</th><th>Exactly</th><th>At Least</th></tr>';
            let exactProbs = [];
            for (let k = 0; k <= secondaryVal; k++) {
                const prob = combinations(secondaryVal, k) * Math.pow(p, k) * Math.pow(1 - p, secondaryVal - k);
                exactProbs.push(prob);
            }
            for (let k = 0; k <= secondaryVal; k++) {
                labels.push(k);
                const e = (exactProbs[k] * 100).toFixed(1);
                const c = (exactProbs.slice(k).reduce((a, b) => a + b, 0) * 100).toFixed(1);
                exactData.push(e); cumulativeData.push(c);
                const isSelected = selectedRows.some(r => r.id === k);
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="${isSelected ? 'selected' : ''}" onclick="toggleRowSelection(${k}, ${c})">
                        <td>${k}</td><td>${e}%</td><td>${c}%</td>
                    </tr>`);
            }
            renderChart(labels, [
                {type:'bar', data:exactData, color:'rgba(99, 102, 241, 0.4)', label: 'Exactly'},
                {type:'line', data:cumulativeData, color:'#f97316', label: 'At Least'}
            ]);
        } else {
            thead.innerHTML = '<tr><th>Dice Pool</th><th>Prob. of Success</th></tr>';
            for (let n = 1; n <= 10; n++) {
                labels.push(n + 'd');
                let probSum = 0;
                for (let k = secondaryVal; k <= n; k++) {
                    probSum += combinations(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
                }
                const pct = (probSum * 100).toFixed(1);
                cumulativeData.push(pct);
                const isSelected = selectedRows.some(r => r.id === n);
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="${isSelected ? 'selected' : ''}" onclick="toggleRowSelection(${n}, ${pct})">
                        <td>${n}d</td><td class="${pct > 70 ? 'high' : pct < 30 ? 'low' : ''}">${pct}%</td>
                    </tr>`);
            }
            renderChart(labels, [{type:'line', data:cumulativeData, color:'#6366f1', label: 'Success Chance'}]);
        }
        updateCompareDisplay();
    }

    function updateCompareDisplay() {
        const display = document.getElementById('compareDisplay');
        if (selectedRows.length < 2) {
            display.innerHTML = `<span style="color:#94a3b8; font-weight:normal; font-size:0.75rem">Tap two rows to see the difference</span>`;
            return;
        }
        const r1 = selectedRows[0], r2 = selectedRows[1];
        const diff = Math.abs(r1.prob - r2.prob).toFixed(1);
        display.innerHTML = `<span>${r1.prob}%</span> <span style="color:#94a3b8">vs</span> <span>${r2.prob}%</span> <span class="diff-tag">Δ ${diff}%</span>`;
    }

    function renderChart(labels, datasets) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: datasets.map(d => ({
                    type: d.type, label: d.label, data: d.data, borderColor: d.color, backgroundColor: d.color,
                    borderWidth: 2, pointRadius: 3, tension: 0.3, borderRadius: 3
                }))
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    x: { ticks: { font: { size: 10 } }, grid: { display: false } },
                    y: { beginAtZero: true, max: 100, ticks: { font: { size: 10 }, stepSize: 25, callback: v => v + '%' } }
                },
                plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 8, font: { size: 9 } } } }
            }
        });
    }

    calculate();
</script>
</body>
</html>
